name: ãƒªãƒªãƒ¼ã‚¹è‡ªå‹•åŒ–

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      release_type:
        description: 'ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚¤ãƒ—'
        required: true
        default: 'patch'
        type: choice
        options:
        - patch
        - minor
        - major
      prerelease:
        description: 'ãƒ—ãƒ¬ãƒªãƒªãƒ¼ã‚¹'
        required: false
        default: false
        type: boolean

jobs:
  check-changes:
    name: å¤‰æ›´å†…å®¹ã®ç¢ºèª
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      release_type: ${{ steps.check.outputs.release_type }}

    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: å¤‰æ›´å†…å®¹ã®åˆ†æ
        id: check
        run: |
          # æœ€æ–°ã®ã‚¿ã‚°ã‚’å–å¾—
          latest_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "æœ€æ–°ã‚¿ã‚°: $latest_tag"

          # æœ€æ–°ã‚¿ã‚°ä»¥é™ã®ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
          commits=$(git log ${latest_tag}..HEAD --oneline --pretty=format:"%s" || git log --oneline --pretty=format:"%s")
          echo "ã‚³ãƒŸãƒƒãƒˆä¸€è¦§:"
          echo "$commits"

          # Conventional Commits ã«åŸºã¥ã„ã¦ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚¤ãƒ—ã‚’åˆ¤å®š
          should_release="false"
          release_type="patch"

          if echo "$commits" | grep -q "^feat\|^feature"; then
            should_release="true"
            release_type="minor"
            echo "æ–°æ©Ÿèƒ½ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸ - minor ãƒªãƒªãƒ¼ã‚¹"
          elif echo "$commits" | grep -q "^fix\|^bugfix"; then
            should_release="true"
            release_type="patch"
            echo "ãƒã‚°ä¿®æ­£ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ - patch ãƒªãƒªãƒ¼ã‚¹"
          elif echo "$commits" | grep -q "BREAKING CHANGE\|^feat!:\|^fix!:"; then
            should_release="true"
            release_type="major"
            echo "ç ´å£Šçš„å¤‰æ›´ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ - major ãƒªãƒªãƒ¼ã‚¹"
          elif echo "$commits" | grep -q "^docs\|^style\|^refactor\|^perf\|^test\|^chore"; then
            echo "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚„ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã®ã¿ã®å¤‰æ›´ã§ã™"
            # æ‰‹å‹•å®Ÿè¡Œã®å ´åˆã¯ãƒªãƒªãƒ¼ã‚¹ã‚’è¨±å¯
            if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
              should_release="true"
              release_type="${{ github.event.inputs.release_type }}"
            fi
          fi

          # æ‰‹å‹•å®Ÿè¡Œã®å ´åˆã¯è¨­å®šã‚’ä¸Šæ›¸ã
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            should_release="true"
            release_type="${{ github.event.inputs.release_type }}"
          fi

          echo "should_release=$should_release" >> $GITHUB_OUTPUT
          echo "release_type=$release_type" >> $GITHUB_OUTPUT

  quality-check:
    name: ãƒªãƒªãƒ¼ã‚¹å‰å“è³ªãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.should_release == 'true'

    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: uv ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: astral-sh/setup-uv@v1

      - name: Python ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        run: uv python install 3.13

      - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          uv venv --python 3.13
          uv sync --frozen

      - name: å…¨å“è³ªãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
        run: |
          echo "ãƒªãƒªãƒ¼ã‚¹å‰ã®æœ€çµ‚å“è³ªãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œä¸­..."

          # ãƒªãƒ³ãƒ†ã‚£ãƒ³ã‚°
          echo "::group::ãƒªãƒ³ãƒ†ã‚£ãƒ³ã‚°ãƒã‚§ãƒƒã‚¯"
          uv run ruff check .
          echo "::endgroup::"

          # ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
          echo "::group::ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯"
          uv run ruff format --check .
          echo "::endgroup::"

          # å‹ãƒã‚§ãƒƒã‚¯
          echo "::group::å‹ãƒã‚§ãƒƒã‚¯"
          uv run mypy .
          echo "::endgroup::"

          # ãƒ†ã‚¹ãƒˆ
          echo "::group::ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
          uv run pytest --cov=src --cov-report=term-missing --cov-fail-under=60
          echo "::endgroup::"

          echo "âœ… å…¨ã¦ã®å“è³ªãƒã‚§ãƒƒã‚¯ãŒé€šéã—ã¾ã—ãŸ"

  create-release:
    name: ãƒªãƒªãƒ¼ã‚¹ä½œæˆ
    runs-on: ubuntu-latest
    needs: [check-changes, quality-check]
    if: needs.check-changes.outputs.should_release == 'true'

    permissions:
      contents: write

    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: uv ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: astral-sh/setup-uv@v1

      - name: Python ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        run: uv python install 3.13

      - name: ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¨ˆç®—
        id: version
        run: |
          # ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
          current_version=$(grep '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
          echo "ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³: $current_version"

          # ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã«åŸºã¥ã„ã¦æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¨ˆç®—
          IFS='.' read -ra VERSION_PARTS <<< "$current_version"
          major=${VERSION_PARTS[0]}
          minor=${VERSION_PARTS[1]}
          patch=${VERSION_PARTS[2]}

          release_type="${{ needs.check-changes.outputs.release_type }}"

          case $release_type in
            "major")
              major=$((major + 1))
              minor=0
              patch=0
              ;;
            "minor")
              minor=$((minor + 1))
              patch=0
              ;;
            "patch")
              patch=$((patch + 1))
              ;;
          esac

          new_version="$major.$minor.$patch"

          # ãƒ—ãƒ¬ãƒªãƒªãƒ¼ã‚¹ã®å ´åˆ
          if [ "${{ github.event.inputs.prerelease }}" = "true" ]; then
            new_version="$new_version-rc.$(date +%Y%m%d%H%M%S)"
          fi

          echo "æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³: $new_version"
          echo "new_version=$new_version" >> $GITHUB_OUTPUT
          echo "tag_name=v$new_version" >> $GITHUB_OUTPUT

      - name: pyproject.toml ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°
        run: |
          sed -i 's/^version = ".*"/version = "${{ steps.version.outputs.new_version }}"/' pyproject.toml
          echo "pyproject.toml ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ›´æ–°ã—ã¾ã—ãŸ"

      - name: CHANGELOG.md ã®æ›´æ–°
        run: |
          # CHANGELOGãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
          if [ ! -f CHANGELOG.md ]; then
            cat > CHANGELOG.md << 'EOF'
          # Changelog

          All notable changes to this project will be documented in this file.

          The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
          and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

          EOF
          fi

          # æœ€æ–°ã®ã‚¿ã‚°ã‚’å–å¾—
          latest_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
          if [ -n "$latest_tag" ]; then
            commits=$(git log ${latest_tag}..HEAD --oneline --pretty=format:"- %s (%h)")
          else
            commits=$(git log --oneline --pretty=format:"- %s (%h)")
          fi

          # CHANGELOGã«æ–°ã—ã„ã‚¨ãƒ³ãƒˆãƒªã‚’è¿½åŠ 
          temp_file=$(mktemp)
          {
            head -n 6 CHANGELOG.md
            echo ""
            echo "## [${{ steps.version.outputs.new_version }}] - $(date +%Y-%m-%d)"
            echo ""
            echo "### å¤‰æ›´å†…å®¹"
            echo ""
            echo "$commits"
            echo ""
            tail -n +7 CHANGELOG.md
          } > "$temp_file"
          mv "$temp_file" CHANGELOG.md

      - name: å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add pyproject.toml CHANGELOG.md
          git commit -m "chore: bump version to ${{ steps.version.outputs.new_version }}"
          git push

      - name: ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆç”Ÿæˆ
        id: release_notes
        run: |
          # æœ€æ–°ã®ã‚¿ã‚°ã‚’å–å¾—
          latest_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
          if [ -n "$latest_tag" ]; then
            commits=$(git log ${latest_tag}..HEAD --oneline --pretty=format:"- %s")
          else
            commits=$(git log --oneline --pretty=format:"- %s")
          fi

          # ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«åˆ†é¡
          features=$(echo "$commits" | grep "^- feat\|^- feature" || true)
          fixes=$(echo "$commits" | grep "^- fix\|^- bugfix" || true)
          docs=$(echo "$commits" | grep "^- docs" || true)
          others=$(echo "$commits" | grep -v "^- feat\|^- feature\|^- fix\|^- bugfix\|^- docs" || true)

          # ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’æ§‹ç¯‰
          release_notes="## ğŸš€ ãƒªãƒªãƒ¼ã‚¹ ${{ steps.version.outputs.new_version }}"
          release_notes="$release_notes\n\n"

          if [ -n "$features" ]; then
            release_notes="$release_notes### âœ¨ æ–°æ©Ÿèƒ½\n$features\n\n"
          fi

          if [ -n "$fixes" ]; then
            release_notes="$release_notes### ğŸ› ãƒã‚°ä¿®æ­£\n$fixes\n\n"
          fi

          if [ -n "$docs" ]; then
            release_notes="$release_notes### ğŸ“š ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ\n$docs\n\n"
          fi

          if [ -n "$others" ]; then
            release_notes="$release_notes### ğŸ”§ ãã®ä»–ã®å¤‰æ›´\n$others\n\n"
          fi

          release_notes="$release_notes---\n\n"
          release_notes="$release_notes**å®Œå…¨ãªå¤‰æ›´å±¥æ­´**: https://github.com/${{ github.repository }}/compare/${latest_tag}...${{ steps.version.outputs.tag_name }}"

          # æ”¹è¡Œæ–‡å­—ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã¦GitHub Outputã«è¨­å®š
          echo "release_notes<<EOF" >> $GITHUB_OUTPUT
          echo -e "$release_notes" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: GitHub Release ä½œæˆ
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.tag_name }}
          release_name: Release ${{ steps.version.outputs.new_version }}
          body: ${{ steps.release_notes.outputs.release_notes }}
          draft: false
          prerelease: ${{ github.event.inputs.prerelease == 'true' }}

  notify-release:
    name: ãƒªãƒªãƒ¼ã‚¹é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [create-release]
    if: always() && needs.create-release.result == 'success'

    steps:
      - name: ãƒªãƒªãƒ¼ã‚¹å®Œäº†é€šçŸ¥
        run: |
          echo "ğŸ‰ ãƒªãƒªãƒ¼ã‚¹ ${{ needs.create-release.outputs.new_version }} ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸï¼"
          echo "ğŸ“‹ ãƒªãƒªãƒ¼ã‚¹ãƒšãƒ¼ã‚¸: https://github.com/${{ github.repository }}/releases"
          echo "ğŸ”— ã‚¿ã‚°: ${{ needs.create-release.outputs.tag_name }}"
