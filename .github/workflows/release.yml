name: ãƒªãƒªãƒ¼ã‚¹è‡ªå‹•åŒ–

on:
  push:
    tags:
      - 'v*'  # ã‚¿ã‚°ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã®ã¿è‡ªå‹•ãƒªãƒªãƒ¼ã‚¹
  workflow_dispatch:
    inputs:
      release_type:
        description: 'ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚¤ãƒ—'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      prerelease:
        description: 'ãƒ—ãƒ¬ãƒªãƒªãƒ¼ã‚¹'
        required: false
        default: false
        type: boolean

jobs:
  create-release:
    name: ãƒªãƒªãƒ¼ã‚¹ä½œæˆ
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Python ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: uv ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: astral-sh/setup-uv@v7

      - name: ã‚¿ã‚°ã‹ã‚‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
        id: version
        run: |
          # ã‚¿ã‚°ã‹ã‚‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—ï¼ˆv ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’é™¤å»ï¼‰
          tag_name="${{ github.ref_name }}"
          version="${tag_name#v}"
          echo "ãƒãƒ¼ã‚¸ãƒ§ãƒ³: $version"
          echo "ã‚¿ã‚°: $tag_name"
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "tag_name=$tag_name" >> $GITHUB_OUTPUT

      - name: ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆç”Ÿæˆ
        id: release_notes
        run: |
          # æœ€æ–°ã®ã‚¿ã‚°ã‚’å–å¾—
          latest_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
          if [ -n "$latest_tag" ]; then
            commits=$(git log ${latest_tag}..HEAD --oneline --pretty=format:"- %s")
          else
            commits=$(git log --oneline --pretty=format:"- %s")
          fi

          # ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«åˆ†é¡
          features=$(echo "$commits" | grep "^- feat\|^- feature" || true)
          fixes=$(echo "$commits" | grep "^- fix\|^- bugfix" || true)
          docs=$(echo "$commits" | grep "^- docs" || true)
          others=$(echo "$commits" | grep -v "^- feat\|^- feature\|^- fix\|^- bugfix\|^- docs" || true)

          # ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’æ§‹ç¯‰
          release_notes="## ğŸš€ ãƒªãƒªãƒ¼ã‚¹ $version"
          release_notes="$release_notes\n\n"

          if [ -n "$features" ]; then
            release_notes="$release_notes### âœ¨ æ–°æ©Ÿèƒ½\n$features\n\n"
          fi

          if [ -n "$fixes" ]; then
            release_notes="$release_notes### ğŸ› ãƒã‚°ä¿®æ­£\n$fixes\n\n"
          fi

          if [ -n "$docs" ]; then
            release_notes="$release_notes### ğŸ“š ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ\n$docs\n\n"
          fi

          if [ -n "$others" ]; then
            release_notes="$release_notes### ğŸ”§ ãã®ä»–ã®å¤‰æ›´\n$others\n\n"
          fi

          release_notes="$release_notes---\n\n"
          url="https://github.com/${{ github.repository }}"
          release_notes="$release_notes**å®Œå…¨ãªå¤‰æ›´å±¥æ­´**: "
          release_notes="$release_notes$url/compare/${latest_tag}...${{ steps.version.outputs.tag_name }}"

          # æ”¹è¡Œæ–‡å­—ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã¦GitHub Outputã«è¨­å®š
          echo "release_notes<<EOF" >> $GITHUB_OUTPUT
          echo -e "$release_notes" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: CHANGELOG.md æ›´æ–°
        run: |
          # CHANGELOG.md ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
          if [ ! -f CHANGELOG.md ]; then
            echo "# Changelog" > CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "All notable changes to this project will be documented in this file." >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi

          # æ–°ã—ã„ã‚¨ãƒ³ãƒˆãƒªã‚’ CHANGELOG.md ã®å…ˆé ­ã«æŒ¿å…¥
          temp_file=$(mktemp)
          echo "## [${{ steps.version.outputs.version }}] - $(date -u +%Y-%m-%d)" > "$temp_file"
          echo "" >> "$temp_file"
          notes="${{ steps.release_notes.outputs.release_notes }}"
          echo -e "$notes" | sed 's/^## ğŸš€ ãƒªãƒªãƒ¼ã‚¹ [0-9.]*//' >> "$temp_file"
          echo "" >> "$temp_file"

          # æ—¢å­˜ã® CHANGELOG.md ã®å†…å®¹ã‚’è¿½åŠ ï¼ˆæœ€åˆã®è¡Œã€Œ# Changelogã€ä»¥é™ï¼‰
          if [ -f CHANGELOG.md ]; then
            tail -n +2 CHANGELOG.md >> "$temp_file"
          fi

          mv "$temp_file" CHANGELOG.md

      - name: README.md ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒãƒƒã‚¸æ›´æ–°
        run: |
          # README.md ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒãƒƒã‚¸ã‚’æ›´æ–°
          if [ -f README.md ]; then
            # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒãƒƒã‚¸ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ›´æ–°
            sed -i "s/version-[0-9.]\+-/version-${{ steps.version.outputs.version }}-/g" README.md
            sed -i "s/v[0-9.]\+/v${{ steps.version.outputs.version }}/g" README.md
          fi

      - name: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°ã‚’ã‚³ãƒŸãƒƒãƒˆ
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # main ãƒ–ãƒ©ãƒ³ãƒã«åˆ‡ã‚Šæ›¿ãˆ
          git checkout main

          git add CHANGELOG.md README.md
          if git diff --staged --quiet; then
            echo "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“"
          else
            git commit -m "docs: update documentation for v${{ steps.version.outputs.version }}

            - Update CHANGELOG.md with release notes
            - Update version badges in README.md"
            git push origin main
          fi

      - name: GitHub Release ä½œæˆ
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.tag_name }}
          release_name: Release ${{ steps.version.outputs.version }}
          body: ${{ steps.release_notes.outputs.release_notes }}
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, 'rc') }}

  notify-release:
    name: ãƒªãƒªãƒ¼ã‚¹é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [create-release]
    if: always() && needs.create-release.result == 'success'

    steps:
      - name: ãƒªãƒªãƒ¼ã‚¹å®Œäº†é€šçŸ¥
        run: |
          echo "ğŸ‰ ãƒªãƒªãƒ¼ã‚¹ ${{ github.ref_name }} ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸï¼"
          echo "ğŸ“‹ ãƒªãƒªãƒ¼ã‚¹ãƒšãƒ¼ã‚¸: https://github.com/${{ github.repository }}/releases"
          echo "ğŸ”— ã‚¿ã‚°: ${{ github.ref_name }}"
