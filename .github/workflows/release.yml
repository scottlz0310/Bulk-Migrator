name: Release Automation

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag to release (e.g. v1.2.3)'
        required: false

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      tag_name: ${{ steps.version.outputs.tag_name }}
      release_notes: ${{ steps.notes.outputs.release_notes }}

    env:
      PYTHON_VERSION: '3.13'
      TAG_INPUT: ${{ github.event.inputs.tag_name }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN != '' && secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up uv
        uses: astral-sh/setup-uv@v7

      - name: Determine version information
        id: version
        shell: bash
        run: |
          tag_name="$TAG_INPUT"
          if [ -z "$tag_name" ]; then
            tag_name="${GITHUB_REF_NAME:-}"
          fi
          if [ -z "$tag_name" ]; then
            echo "A tag name is required when running this workflow manually." >&2
            exit 1
          fi

          version="${tag_name#v}"

          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "tag_name=$tag_name" >> "$GITHUB_OUTPUT"

      - name: Collect release notes
        id: notes
        shell: bash
        run: |
          latest_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -n "$latest_tag" ]; then
            commits=$(git log "${latest_tag}..HEAD" --oneline --pretty=format:"- %s (%h)")
          else
            commits=$(git log --oneline --pretty=format:"- %s (%h)")
          fi

          features=$(echo "$commits" | grep -E '^- (feat|feature)' || true)
          fixes=$(echo "$commits" | grep -E '^- (fix|bugfix)' || true)
          docs=$(echo "$commits" | grep -E '^- docs' || true)
          others=$(echo "$commits" | grep -Ev '^- (feat|feature|fix|bugfix|docs)' || true)

          release_notes="## Release ${{ steps.version.outputs.version }}\n\n"

          if [ -n "$features" ]; then
            release_notes="${release_notes}### Features\n${features}\n\n"
          fi
          if [ -n "$fixes" ]; then
            release_notes="${release_notes}### Fixes\n${fixes}\n\n"
          fi
          if [ -n "$docs" ]; then
            release_notes="${release_notes}### Documentation\n${docs}\n\n"
          fi
          if [ -n "$others" ]; then
            release_notes="${release_notes}### Other Changes\n${others}\n\n"
          fi

          release_notes="${release_notes}---\n\n"
          latest_for_compare="$latest_tag"
          if [ -z "$latest_for_compare" ]; then
            latest_for_compare=$(git rev-list --max-parents=0 HEAD | tail -n 1)
          fi
          repo_url="https://github.com/${{ github.repository }}"
          compare_url="$repo_url/compare/${latest_for_compare}...${{ steps.version.outputs.tag_name }}"
          release_notes="${release_notes}Full changelog: ${compare_url}"

          {
            echo 'release_notes<<EOF'
            printf '%s\n' "$release_notes"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Update CHANGELOG.md
        shell: bash
        run: |
          if [ ! -f CHANGELOG.md ]; then
            printf '%s\n' \
              '# Changelog' \
              '' \
              'All notable changes to this project will be documented in this file.' \
              '' \
              'The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),' \
              'and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).' \
              > CHANGELOG.md
          fi

          temp_file=$(mktemp)
          {
            echo "## ${{ steps.version.outputs.version }} - $(date -u +%Y-%m-%d)"
            echo
            printf '%s\n' "${{ steps.notes.outputs.release_notes }}"
            echo
            tail -n +2 CHANGELOG.md
          } > "$temp_file"
          mv "$temp_file" CHANGELOG.md

      - name: Update README badge
        shell: bash
        run: |
          if [ -f README.md ]; then
            sed -i "s/version-[0-9.]*-/version-${{ steps.version.outputs.version }}-/g" README.md
            sed -i "s/v[0-9.][0-9.]*[0-9]/v${{ steps.version.outputs.version }}/g" README.md
          fi

      - name: Commit documentation updates
        shell: bash
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git checkout main
          git add CHANGELOG.md README.md
          if git diff --staged --quiet; then
            echo "No documentation changes to commit."
          else
            git commit -m "docs: update release notes for v${{ steps.version.outputs.version }}"
            git push origin main
          fi

      - name: Create GitHub release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.tag_name }}
          release_name: Release ${{ steps.version.outputs.version }}
          body: ${{ steps.notes.outputs.release_notes }}
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, 'rc') }}

  notify-release:
    name: Notify
    runs-on: ubuntu-latest
    needs: [create-release]
    if: always() && needs.create-release.result == 'success'

    steps:
      - name: Print summary
        env:
          RELEASE_TAG: ${{ needs.create-release.outputs.tag_name }}
          RELEASE_NOTES: ${{ needs.create-release.outputs.release_notes }}
        run: |
          echo "Release $RELEASE_TAG completed."
          printf '%s\n' "$RELEASE_NOTES"
