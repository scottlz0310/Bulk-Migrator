name: セキュリチE��スキャン

on:
  # 手動実行�Eみ�E��Eライベ�EトリポジトリのActions実行時間制紁E�Eため�E�E
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'スキャンタイチE
        required: true
        default: 'comprehensive'
        type: choice
        options:
          - 'comprehensive'
          - 'codeql-only'
          - 'security-only'
          - 'sbom-only'
# 緊急時�Eみ自動実衁E
  # push:
  #   branches: [main, develop]
  # pull_request:
  #   branches: [ main, develop ]
  # schedule:
  #   # 毎週月曜日の午前3時！ETC�E�に実衁E
  #   - cron: '0 3 * * 1'

jobs:
  codeql:
    name: CodeQL セキュリチE��刁E��
    runs-on: ubuntu-latest
    # 手動実行時のみ、かつcodeqlスキャンが選択された場合�Eみ実衁E
    if: >
      github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.scan_type == 'comprehensive' ||
       github.event.inputs.scan_type == 'codeql-only')

    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: ['python']

    steps:
      - name: チェチE��アウチE
        uses: actions/checkout@v5

      - name: CodeQL 初期匁E
        id: codeql-init
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ matrix.language }}
          queries: security-extended,security-and-quality
        continue-on-error: true

      - name: 自動ビルチE
        if: steps.codeql-init.outcome == 'success'
        uses: github/codeql-action/autobuild@v4
        continue-on-error: true

      - name: CodeQL 刁E��実衁E
        if: steps.codeql-init.outcome == 'success'
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:${{matrix.language}}"
        continue-on-error: true

      - name: CodeQL スキチE�E通知
        if: steps.codeql-init.outcome != 'success'
        run: |
          echo "⚠�E�ECodeQL刁E��がスキチE�Eされました"
          echo "琁E��: GitHub Advanced Securityが有効でなぁE��、E
          echo "コードスキャニングが設定されてぁE��せん"
          url="https://docs.github.com/en/code-security/code-scanning"
          path="automatically-scanning-your-code-for-vulnerabilities-and-errors"
          echo "詳細: $url/$path/setting-up-code-scanning-for-a-repository"

  comprehensive-security-scan:
    name: 匁E��皁E��キュリチE��スキャン
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.scan_type == 'comprehensive' ||
       github.event.inputs.scan_type == 'security-only')

    permissions:
      contents: read
      security-events: write

    steps:
      - name: チェチE��アウチE
        uses: actions/checkout@v5

      - name: Python セチE��アチE�E
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'
          allow-prereleases: true

      - name: uv セチE��アチE�E
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: 依存関係インスト�Eル
        run: uv sync --python 3.13

      - name: 匁E��皁E��キュリチE��スキャン実衁E
        run: |
          echo "🚀 セキュリチE��スキャンを開始しまぁE.."
          uv run python scripts/security_scan.py --scan-type=all
        continue-on-error: true

      - name: セキュリチE��レポ�Eト�E確誁E
        run: |
          echo "📄 セキュリチE��レポ�Eトを確認中..."

          # レポ�Eトディレクトリの存在確誁E
          if [ ! -d "security_reports" ]; then
            echo "❁Esecurity_reports チE��レクトリが存在しません"
            exit 1
          fi

          echo "📁 生�Eされたファイル:"
          ls -la security_reports/ || echo "ファイル一覧の取得に失敁E

          if [ -f security_reports/security_summary.json ]; then
            echo "✁EセキュリチE��スキャン結果サマリー:"
            cat security_reports/security_summary.json | jq '.' || cat security_reports/security_summary.json

            # 脁E��性の数をチェチE��
            summary='security_reports/security_summary.json'
            bandit_issues=$(jq '.scan_results.bandit.issues_count // 0' \
              $summary 2>/dev/null || echo "0")
            audit_vulnerabilities=$(jq '.scan_results.pip_audit.vulnerabilities_count // 0' \
              $summary 2>/dev/null || echo "0")

            echo "Bandit 問題数: $bandit_issues"
            echo "pip-audit 脁E��性数: $audit_vulnerabilities"

            # セキュリチE��問題�E報告（警告レベル�E�E
            if [ "$bandit_issues" -gt 0 ] || [ "$audit_vulnerabilities" -gt 0 ]; then
              echo "⚠�E�E セキュリチE��問題が検�Eされました�E�警告レベル�E�E
              echo "詳細はセキュリチE��レポ�Eトを確認してください"
            else
              echo "✁EセキュリチE��問題�E検�Eされませんでした"
            fi
          else
            echo "⚠�E�E security_summary.json が見つかりません。個別レポ�Eトを確認しまぁE.."

            # 個別レポ�Eト�E確誁E
            bandit_issues=0
            audit_vulnerabilities=0

            if [ -f security_reports/bandit_report.json ]; then
              bandit_issues=$(jq '.results | length' \
                security_reports/bandit_report.json 2>/dev/null || echo "0")
              echo "Bandit レポ�Eトが見つかりました: $bandit_issues 件の問顁E
            fi

            if [ -f security_reports/pip_audit_report.json ]; then
              audit_vulnerabilities=$(jq '.vulnerabilities | length' \
                security_reports/pip_audit_report.json 2>/dev/null || echo "0")
              echo "pip-audit レポ�Eトが見つかりました: $audit_vulnerabilities 件の脁E��性"
            fi

            echo "Bandit 問題数: $bandit_issues"
            echo "pip-audit 脁E��性数: $audit_vulnerabilities"

            if [ "$bandit_issues" -gt 0 ] || [ "$audit_vulnerabilities" -gt 0 ]; then
              echo "⚠�E�E セキュリチE��問題が検�Eされました"
            else
              echo "✁EセキュリチE��問題�E検�Eされませんでした"
            fi
          fi

      - name: セキュリチE��レポ�Eト�EアチE�EローチE
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: security_reports/
          retention-days: 30

  secret-scan:
    name: 秘寁E��報スキャン
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write

    steps:
      - name: チェチE��アウチE
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # 全履歴を取征E

      - name: TruffleHog による秘寁E��報スキャン
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          extra_args: --debug --only-verified

  sbom-generation:
    name: SBOM 生�E
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.scan_type == 'comprehensive' ||
       github.event.inputs.scan_type == 'sbom-only')

    permissions:
      contents: read
      actions: read

    steps:
      - name: チェチE��アウチE
        uses: actions/checkout@v5

      - name: Python セチE��アチE�E
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'
          allow-prereleases: true

      - name: uv セチE��アチE�E
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: 依存関係インスト�Eル
        run: uv sync --python 3.13

      - name: SBOM 生�E
        run: |
          uv run python scripts/security_scan.py --scan-type=sbom

      - name: SBOM 検証
        run: |
          if [ -f security_reports/sbom.json ]; then
            echo "✁ESBOM が正常に生�Eされました"
            echo "コンポ�Eネント数: $(jq '.components | length' security_reports/sbom.json)"
            echo "生�E日晁E $(jq -r '.metadata.timestamp' security_reports/sbom.json)"
          else
            echo "❁ESBOM の生�Eに失敗しました"
            exit 1
          fi

      - name: SBOM アチE�EローチE
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: security_reports/sbom.json
          retention-days: 90
