name: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³

on:
  # æ‰‹å‹•å®Ÿè¡Œã®ã¿ï¼ˆãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã®Actionså®Ÿè¡Œæ™‚é–“åˆ¶ç´„ã®ãŸã‚ï¼‰
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'ã‚¹ã‚­ãƒ£ãƒ³ã‚¿ã‚¤ãƒ—'
        required: true
        default: 'comprehensive'
        type: choice
        options:
          - 'comprehensive'
          - 'codeql-only'
          - 'security-only'
          - 'sbom-only'
# ç·Šæ€¥æ™‚ã®ã¿è‡ªå‹•å®Ÿè¡Œ
  # push:
  #   branches: [main, develop]
  # pull_request:
  #   branches: [ main, develop ]
  # schedule:
  #   # æ¯é€±æœˆæ›œæ—¥ã®åˆå‰3æ™‚ï¼ˆUTCï¼‰ã«å®Ÿè¡Œ
  #   - cron: '0 3 * * 1'

jobs:
  codeql:
    name: CodeQL ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æ
    runs-on: ubuntu-latest
    # æ‰‹å‹•å®Ÿè¡Œæ™‚ã®ã¿ã€ã‹ã¤codeqlã‚¹ã‚­ãƒ£ãƒ³ãŒé¸æŠã•ã‚ŒãŸå ´åˆã®ã¿å®Ÿè¡Œ
    if: >
      github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.scan_type == 'comprehensive' ||
       github.event.inputs.scan_type == 'codeql-only')

    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: ['python']

    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v5

      - name: CodeQL åˆæœŸåŒ–
        id: codeql-init
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ matrix.language }}
          queries: security-extended,security-and-quality
        continue-on-error: true

      - name: è‡ªå‹•ãƒ“ãƒ«ãƒ‰
        if: steps.codeql-init.outcome == 'success'
        uses: github/codeql-action/autobuild@v4
        continue-on-error: true

      - name: CodeQL åˆ†æå®Ÿè¡Œ
        if: steps.codeql-init.outcome == 'success'
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:${{matrix.language}}"
        continue-on-error: true

      - name: CodeQL ã‚¹ã‚­ãƒƒãƒ—é€šçŸ¥
        if: steps.codeql-init.outcome != 'success'
        run: |
          echo "âš ï¸ CodeQLåˆ†æãŒã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸ"
          echo "ç†ç”±: GitHub Advanced SecurityãŒæœ‰åŠ¹ã§ãªã„ã‹ã€"
          echo "ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ‹ãƒ³ã‚°ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
          url="https://docs.github.com/en/code-security/code-scanning"
          path="automatically-scanning-your-code-for-vulnerabilities-and-errors"
          echo "è©³ç´°: $url/$path/setting-up-code-scanning-for-a-repository"

  comprehensive-security-scan:
    name: åŒ…æ‹¬çš„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.scan_type == 'comprehensive' ||
       github.event.inputs.scan_type == 'security-only')

    permissions:
      contents: read
      security-events: write

    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v5

      - name: Python ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          allow-prereleases: true

      - name: uv ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: uv sync --python 3.13

      - name: åŒ…æ‹¬çš„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œ
        run: |
          echo "ğŸš€ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã‚’é–‹å§‹ã—ã¾ã™..."
          uv run python scripts/security_scan.py --scan-type=all
        continue-on-error: true

      - name: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆã®ç¢ºèª
        run: |
          echo "ğŸ“„ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆã‚’ç¢ºèªä¸­..."

          # ãƒ¬ãƒãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å­˜åœ¨ç¢ºèª
          if [ ! -d "security_reports" ]; then
            echo "âŒ security_reports ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“"
            exit 1
          fi

          echo "ğŸ“ ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:"
          ls -la security_reports/ || echo "ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã®å–å¾—ã«å¤±æ•—"

          if [ -f security_reports/security_summary.json ]; then
            echo "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³çµæœã‚µãƒãƒªãƒ¼:"
            cat security_reports/security_summary.json | jq '.' || cat security_reports/security_summary.json

            # è„†å¼±æ€§ã®æ•°ã‚’ãƒã‚§ãƒƒã‚¯
            summary='security_reports/security_summary.json'
            bandit_issues=$(jq '.scan_results.bandit.issues_count // 0' \
              $summary 2>/dev/null || echo "0")
            audit_vulnerabilities=$(jq '.scan_results.pip_audit.vulnerabilities_count // 0' \
              $summary 2>/dev/null || echo "0")

            echo "Bandit å•é¡Œæ•°: $bandit_issues"
            echo "pip-audit è„†å¼±æ€§æ•°: $audit_vulnerabilities"

            # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œã®å ±å‘Šï¼ˆè­¦å‘Šãƒ¬ãƒ™ãƒ«ï¼‰
            if [ "$bandit_issues" -gt 0 ] || [ "$audit_vulnerabilities" -gt 0 ]; then
              echo "âš ï¸  ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸï¼ˆè­¦å‘Šãƒ¬ãƒ™ãƒ«ï¼‰"
              echo "è©³ç´°ã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„"
            else
              echo "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
            fi
          else
            echo "âš ï¸  security_summary.json ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å€‹åˆ¥ãƒ¬ãƒãƒ¼ãƒˆã‚’ç¢ºèªã—ã¾ã™..."

            # å€‹åˆ¥ãƒ¬ãƒãƒ¼ãƒˆã®ç¢ºèª
            bandit_issues=0
            audit_vulnerabilities=0

            if [ -f security_reports/bandit_report.json ]; then
              bandit_issues=$(jq '.results | length' \
                security_reports/bandit_report.json 2>/dev/null || echo "0")
              echo "Bandit ãƒ¬ãƒãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ: $bandit_issues ä»¶ã®å•é¡Œ"
            fi

            if [ -f security_reports/pip_audit_report.json ]; then
              audit_vulnerabilities=$(jq '.vulnerabilities | length' \
                security_reports/pip_audit_report.json 2>/dev/null || echo "0")
              echo "pip-audit ãƒ¬ãƒãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ: $audit_vulnerabilities ä»¶ã®è„†å¼±æ€§"
            fi

            echo "Bandit å•é¡Œæ•°: $bandit_issues"
            echo "pip-audit è„†å¼±æ€§æ•°: $audit_vulnerabilities"

            if [ "$bandit_issues" -gt 0 ] || [ "$audit_vulnerabilities" -gt 0 ]; then
              echo "âš ï¸  ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            else
              echo "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
            fi
          fi

      - name: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: security_reports/
          retention-days: 30

  secret-scan:
    name: ç§˜å¯†æƒ…å ±ã‚¹ã‚­ãƒ£ãƒ³
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write

    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—

      - name: TruffleHog ã«ã‚ˆã‚‹ç§˜å¯†æƒ…å ±ã‚¹ã‚­ãƒ£ãƒ³
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          extra_args: --debug --only-verified

  sbom-generation:
    name: SBOM ç”Ÿæˆ
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.scan_type == 'comprehensive' ||
       github.event.inputs.scan_type == 'sbom-only')

    permissions:
      contents: read
      actions: read

    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v5

      - name: Python ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          allow-prereleases: true

      - name: uv ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: uv sync --python 3.13

      - name: SBOM ç”Ÿæˆ
        run: |
          uv run python scripts/security_scan.py --scan-type=sbom

      - name: SBOM æ¤œè¨¼
        run: |
          if [ -f security_reports/sbom.json ]; then
            echo "âœ… SBOM ãŒæ­£å¸¸ã«ç”Ÿæˆã•ã‚Œã¾ã—ãŸ"
            echo "ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ•°: $(jq '.components | length' security_reports/sbom.json)"
            echo "ç”Ÿæˆæ—¥æ™‚: $(jq -r '.metadata.timestamp' security_reports/sbom.json)"
          else
            echo "âŒ SBOM ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi

      - name: SBOM ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: security_reports/sbom.json
          retention-days: 90
