name: ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆå“è³ªã‚²ãƒ¼ãƒˆ

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  quality-gate:
    name: å“è³ªã‚²ãƒ¼ãƒˆç¢ºèª
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write
      checks: write

    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v5

      - name: Python ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v6
        with:
          python-version: "3.14"

      - name: uv ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: uv sync --python 3.13

      - name: å“è³ªãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
        id: quality_check
        run: |
          echo "å“è³ªãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œä¸­..."

          # ãƒªãƒ³ãƒ†ã‚£ãƒ³ã‚°ãƒã‚§ãƒƒã‚¯
          echo "::group::ãƒªãƒ³ãƒ†ã‚£ãƒ³ã‚°ãƒã‚§ãƒƒã‚¯"
          if ! uv run ruff check .; then
            echo "lint_failed=true" >> $GITHUB_OUTPUT
            echo "âŒ ãƒªãƒ³ãƒ†ã‚£ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
          else
            echo "âœ… ãƒªãƒ³ãƒ†ã‚£ãƒ³ã‚°ãƒã‚§ãƒƒã‚¯é€šé"
          fi
          echo "::endgroup::"

          # ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯
          echo "::group::ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯"
          if ! uv run ruff format --check .; then
            echo "format_failed=true" >> $GITHUB_OUTPUT
            echo "âŒ ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
          else
            echo "âœ… ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯é€šé"
          fi
          echo "::endgroup::"

          # å‹ãƒã‚§ãƒƒã‚¯
          echo "::group::å‹ãƒã‚§ãƒƒã‚¯"
          if ! uv run mypy .; then
            echo "type_failed=true" >> $GITHUB_OUTPUT
            echo "âŒ å‹ã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
          else
            echo "âœ… å‹ãƒã‚§ãƒƒã‚¯é€šé"
          fi
          echo "::endgroup::"

          # ãƒ†ã‚¹ãƒˆã¨ã‚«ãƒãƒ¬ãƒƒã‚¸ï¼ˆä¸¦åˆ—å®Ÿè¡Œï¼‰
          echo "::group::ãƒ†ã‚¹ãƒˆã¨ã‚«ãƒãƒ¬ãƒƒã‚¸"
          if ! uv run pytest --cov=src --cov-report=term-missing \
            --cov-fail-under=60 --junit-xml=pytest-results.xml -n auto; then
            echo "test_failed=true" >> $GITHUB_OUTPUT
            echo "âŒ ãƒ†ã‚¹ãƒˆã¾ãŸã¯ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒåŸºæº–ã‚’æº€ãŸã—ã¦ã„ã¾ã›ã‚“"
          else
            echo "âœ… ãƒ†ã‚¹ãƒˆã¨ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒã‚§ãƒƒã‚¯é€šé"
          fi
          echo "::endgroup::"

      - name: å“è³ªã‚²ãƒ¼ãƒˆçµæœã‚³ãƒ¡ãƒ³ãƒˆ
        if: always()
        uses: actions/github-script@v8
        with:
          script: |
            const { lint_failed, format_failed, type_failed, test_failed } = process.env;

            let comment = '## ğŸ” å“è³ªãƒã‚§ãƒƒã‚¯çµæœ\n\n';
            let hasFailures = false;

            // ãƒªãƒ³ãƒ†ã‚£ãƒ³ã‚°çµæœ
            if (lint_failed === 'true') {
              comment += 'âŒ **ãƒªãƒ³ãƒ†ã‚£ãƒ³ã‚°**: ã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ\n';
              comment += '   - `uv run ruff check .` ã‚’å®Ÿè¡Œã—ã¦ä¿®æ­£ã—ã¦ãã ã•ã„\n\n';
              hasFailures = true;
            } else {
              comment += 'âœ… **ãƒªãƒ³ãƒ†ã‚£ãƒ³ã‚°**: é€šé\n\n';
            }

            // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆçµæœ
            if (format_failed === 'true') {
              comment += 'âŒ **ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ**: ã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ\n';
              comment += '   - `uv run ruff format .` ã‚’å®Ÿè¡Œã—ã¦ä¿®æ­£ã—ã¦ãã ã•ã„\n\n';
              hasFailures = true;
            } else {
              comment += 'âœ… **ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ**: é€šé\n\n';
            }

            // å‹ãƒã‚§ãƒƒã‚¯çµæœ
            if (type_failed === 'true') {
              comment += 'âŒ **å‹ãƒã‚§ãƒƒã‚¯**: ã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ\n';
              comment += '   - `uv run mypy .` ã‚’å®Ÿè¡Œã—ã¦å‹ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„\n\n';
              hasFailures = true;
            } else {
              comment += 'âœ… **å‹ãƒã‚§ãƒƒã‚¯**: é€šé\n\n';
            }

            // ãƒ†ã‚¹ãƒˆçµæœ
            if (test_failed === 'true') {
              comment += 'âŒ **ãƒ†ã‚¹ãƒˆãƒ»ã‚«ãƒãƒ¬ãƒƒã‚¸**: åŸºæº–ã‚’æº€ãŸã—ã¦ã„ã¾ã›ã‚“\n';
              comment += '   - ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¦ã„ã‚‹ã‹ã€ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒ60%æœªæº€ã§ã™\n';
              comment += '   - `uv run pytest --cov=src --cov-report=term-missing` ã‚’å®Ÿè¡Œã—ã¦ç¢ºèªã—ã¦ãã ã•ã„\n\n';
              hasFailures = true;
            } else {
              comment += 'âœ… **ãƒ†ã‚¹ãƒˆãƒ»ã‚«ãƒãƒ¬ãƒƒã‚¸**: é€šéï¼ˆ60%ä»¥ä¸Šï¼‰\n\n';
            }

            if (hasFailures) {
              comment += '---\n';
              comment += 'âš ï¸ **ãƒãƒ¼ã‚¸ãƒ–ãƒ­ãƒƒã‚¯**: ä¸Šè¨˜ã®å•é¡Œã‚’ä¿®æ­£ã—ã¦ã‹ã‚‰ãƒãƒ¼ã‚¸ã—ã¦ãã ã•ã„ã€‚\n';
              comment += '\n### ä¿®æ­£æ‰‹é †\n';
              comment += '1. ãƒ­ãƒ¼ã‚«ãƒ«ã§ `make lint` ã¾ãŸã¯ `uv run ruff check .` ã‚’å®Ÿè¡Œ\n';
              comment += '2. `make format` ã¾ãŸã¯ `uv run ruff format .` ã§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä¿®æ­£\n';
              comment += '3. `make typecheck` ã¾ãŸã¯ `uv run mypy .` ã§å‹ã‚¨ãƒ©ãƒ¼ç¢ºèª\n';
              comment += '4. `make test` ã¾ãŸã¯ `uv run pytest` ã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ\n';
              comment += '5. ä¿®æ­£å¾Œã«ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥\n';
            } else {
              comment += 'ğŸ‰ **å…¨ã¦ã®å“è³ªãƒã‚§ãƒƒã‚¯ãŒé€šéã—ã¾ã—ãŸï¼ãƒãƒ¼ã‚¸å¯èƒ½ã§ã™ã€‚**\n';
            }

            // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¢ã—ã¦æ›´æ–°ã€ãªã‘ã‚Œã°æ–°è¦ä½œæˆ
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment => {
              return comment.user.type === 'Bot' &&
                comment.body.includes('ğŸ” å“è³ªãƒã‚§ãƒƒã‚¯çµæœ');
            });

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
        env:
          lint_failed: ${{ steps.quality_check.outputs.lint_failed }}
          format_failed: ${{ steps.quality_check.outputs.format_failed }}
          type_failed: ${{ steps.quality_check.outputs.type_failed }}
          test_failed: ${{ steps.quality_check.outputs.test_failed }}

      - name: å“è³ªã‚²ãƒ¼ãƒˆå¤±æ•—æ™‚ã®çµ‚äº†
        if: >
          steps.quality_check.outputs.lint_failed == 'true' ||
          steps.quality_check.outputs.format_failed == 'true' ||
          steps.quality_check.outputs.type_failed == 'true' ||
          steps.quality_check.outputs.test_failed == 'true'
        run: |
          echo "âŒ å“è³ªã‚²ãƒ¼ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒãƒ¼ã‚¸ã™ã‚‹å‰ã«å•é¡Œã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚"
          exit 1
