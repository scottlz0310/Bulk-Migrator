name: プルリクエスト品質ゲーチE

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  quality-gate:
    name: 品質ゲート確誁E
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write
      checks: write

    steps:
      - name: チェチE��アウチE
        uses: actions/checkout@v5

      - name: Python セチE��アチE�E
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: uv セチE��アチE�E
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: 依存関係インスト�Eル
        run: uv sync --python 3.13

      - name: 品質チェチE��実衁E
        id: quality_check
        run: |
          echo "品質チェチE��を実行中..."

          # リンチE��ングチェチE��
          echo "::group::リンチE��ングチェチE��"
          if ! uv run ruff check .; then
            echo "lint_failed=true" >> $GITHUB_OUTPUT
            echo "❁EリンチE��ングエラーが検�Eされました"
          else
            echo "✁EリンチE��ングチェチE��通過"
          fi
          echo "::endgroup::"

          # フォーマットチェチE��
          echo "::group::フォーマットチェチE��"
          if ! uv run ruff format --check .; then
            echo "format_failed=true" >> $GITHUB_OUTPUT
            echo "❁Eフォーマットエラーが検�Eされました"
          else
            echo "✁EフォーマットチェチE��通過"
          fi
          echo "::endgroup::"

          # 型チェチE��
          echo "::group::型チェチE��"
          if ! uv run mypy .; then
            echo "type_failed=true" >> $GITHUB_OUTPUT
            echo "❁E型エラーが検�Eされました"
          else
            echo "✁E型チェチE��通過"
          fi
          echo "::endgroup::"

          # チE��トとカバレチE���E�並列実行！E
          echo "::group::チE��トとカバレチE��"
          if ! uv run pytest --cov=src --cov-report=term-missing \
            --cov-fail-under=60 --junit-xml=pytest-results.xml -n auto; then
            echo "test_failed=true" >> $GITHUB_OUTPUT
            echo "❁EチE��トまた�EカバレチE��が基準を満たしてぁE��せん"
          else
            echo "✁EチE��トとカバレチE��チェチE��通過"
          fi
          echo "::endgroup::"

      - name: 品質ゲート結果コメンチE
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const { lint_failed, format_failed, type_failed, test_failed } = process.env;

            let comment = '## 🔍 品質チェチE��結果\n\n';
            let hasFailures = false;

            // リンチE��ング結果
            if (lint_failed === 'true') {
              comment += '❁E**リンチE��ング**: エラーが検�Eされました\n';
              comment += '   - `uv run ruff check .` を実行して修正してください\n\n';
              hasFailures = true;
            } else {
              comment += '✁E**リンチE��ング**: 通過\n\n';
            }

            // フォーマット結果
            if (format_failed === 'true') {
              comment += '❁E**フォーマッチE*: エラーが検�Eされました\n';
              comment += '   - `uv run ruff format .` を実行して修正してください\n\n';
              hasFailures = true;
            } else {
              comment += '✁E**フォーマッチE*: 通過\n\n';
            }

            // 型チェチE��結果
            if (type_failed === 'true') {
              comment += '❁E**型チェチE��**: エラーが検�Eされました\n';
              comment += '   - `uv run mypy .` を実行して型エラーを修正してください\n\n';
              hasFailures = true;
            } else {
              comment += '✁E**型チェチE��**: 通過\n\n';
            }

            // チE��ト結果
            if (test_failed === 'true') {
              comment += '❁E**チE��ト�EカバレチE��**: 基準を満たしてぁE��せん\n';
              comment += '   - チE��トが失敗してぁE��か、カバレチE��ぁE0%未満です\n';
              comment += '   - `uv run pytest --cov=src --cov-report=term-missing` を実行して確認してください\n\n';
              hasFailures = true;
            } else {
              comment += '✁E**チE��ト�EカバレチE��**: 通過�E�E0%以上）\n\n';
            }

            if (hasFailures) {
              comment += '---\n';
              comment += '⚠�E�E**マ�EジブロチE��**: 上記�E問題を修正してからマ�Eジしてください、En';
              comment += '\n### 修正手頁En';
              comment += '1. ローカルで `make lint` また�E `uv run ruff check .` を実行\n';
              comment += '2. `make format` また�E `uv run ruff format .` でフォーマット修正\n';
              comment += '3. `make typecheck` また�E `uv run mypy .` で型エラー確認\n';
              comment += '4. `make test` また�E `uv run pytest` でチE��ト実行\n';
              comment += '5. 修正後にコミット�Eプッシュ\n';
            } else {
              comment += '🎉 **全ての品質チェチE��が通過しました�E��Eージ可能です、E*\n';
            }

            // 既存�Eコメントを探して更新、なければ新規作�E
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment => {
              return comment.user.type === 'Bot' &&
                comment.body.includes('🔍 品質チェチE��結果');
            });

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
        env:
          lint_failed: ${{ steps.quality_check.outputs.lint_failed }}
          format_failed: ${{ steps.quality_check.outputs.format_failed }}
          type_failed: ${{ steps.quality_check.outputs.type_failed }}
          test_failed: ${{ steps.quality_check.outputs.test_failed }}

      - name: 品質ゲート失敗時の終亁E
        if: >
          steps.quality_check.outputs.lint_failed == 'true' ||
          steps.quality_check.outputs.format_failed == 'true' ||
          steps.quality_check.outputs.type_failed == 'true' ||
          steps.quality_check.outputs.test_failed == 'true'
        run: |
          echo "❁E品質ゲートが失敗しました。�Eルリクエストをマ�Eジする前に問題を修正してください、E
          exit 1
