name: ãƒªãƒªãƒ¼ã‚¹æº–å‚™

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚¤ãƒ—'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      prerelease:
        description: 'ãƒ—ãƒ¬ãƒªãƒªãƒ¼ã‚¹'
        required: false
        default: false
        type: boolean

jobs:
  prepare-release:
    name: ãƒªãƒªãƒ¼ã‚¹æº–å‚™
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Python ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: uv ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: astral-sh/setup-uv@v7

      - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          uv venv --python 3.13
          uv sync

      - name: å“è³ªãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
        run: |
          echo "ãƒªãƒªãƒ¼ã‚¹å‰ã®å“è³ªãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œä¸­..."

          # ãƒªãƒ³ãƒ†ã‚£ãƒ³ã‚°
          echo "::group::ãƒªãƒ³ãƒ†ã‚£ãƒ³ã‚°ãƒã‚§ãƒƒã‚¯"
          uv run ruff check .
          echo "::endgroup::"

          # ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
          echo "::group::ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯"
          uv run ruff format --check .
          echo "::endgroup::"

          # å‹ãƒã‚§ãƒƒã‚¯
          echo "::group::å‹ãƒã‚§ãƒƒã‚¯"
          uv run mypy .
          echo "::endgroup::"

          # ãƒ†ã‚¹ãƒˆ
          echo "::group::ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
          uv run pytest --cov=src --cov-report=term-missing --cov-fail-under=60 --junit-xml=pytest-results.xml
          echo "::endgroup::"

          echo "âœ… å…¨ã¦ã®å“è³ªãƒã‚§ãƒƒã‚¯ãŒé€šéã—ã¾ã—ãŸ"

      - name: ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¨ˆç®—
        id: version
        run: |
          # ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
          current_version=$(grep '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
          echo "ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³: $current_version"

          # ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã«åŸºã¥ã„ã¦æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¨ˆç®—
          IFS='.' read -ra VERSION_PARTS <<< "$current_version"
          major=${VERSION_PARTS[0]}
          minor=${VERSION_PARTS[1]}
          patch=${VERSION_PARTS[2]}

          release_type="${{ github.event.inputs.release_type }}"

          case $release_type in
            "major")
              major=$((major + 1))
              minor=0
              patch=0
              ;;
            "minor")
              minor=$((minor + 1))
              patch=0
              ;;
            "patch")
              patch=$((patch + 1))
              ;;
          esac

          new_version="$major.$minor.$patch"

          # ãƒ—ãƒ¬ãƒªãƒªãƒ¼ã‚¹ã®å ´åˆ
          if [ "${{ github.event.inputs.prerelease }}" = "true" ]; then
            new_version="$new_version-rc.$(date +%Y%m%d%H%M%S)"
          fi

          echo "æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³: $new_version"
          echo "new_version=$new_version" >> $GITHUB_OUTPUT
          echo "tag_name=v$new_version" >> $GITHUB_OUTPUT

      - name: pyproject.toml ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°
        run: |
          sed -i 's/^version = ".*"/version = "${{ steps.version.outputs.new_version }}"/' pyproject.toml
          echo "pyproject.toml ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ›´æ–°ã—ã¾ã—ãŸ"

      - name: CHANGELOG.md ã®æ›´æ–°
        run: |
          # CHANGELOGãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
          if [ ! -f CHANGELOG.md ]; then
            cat > CHANGELOG.md << 'EOF'
          # Changelog

          All notable changes to this project will be documented in this file.

          The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
          and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

          EOF
          fi

          # æœ€æ–°ã®ã‚¿ã‚°ã‚’å–å¾—
          latest_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
          if [ -n "$latest_tag" ]; then
            commits=$(git log ${latest_tag}..HEAD --oneline --pretty=format:"- %s (%h)")
          else
            commits=$(git log --oneline --pretty=format:"- %s (%h)")
          fi

          # CHANGELOGã«æ–°ã—ã„ã‚¨ãƒ³ãƒˆãƒªã‚’è¿½åŠ 
          temp_file=$(mktemp)
          {
            head -n 6 CHANGELOG.md
            echo ""
            echo "## [${{ steps.version.outputs.new_version }}] - $(date +%Y-%m-%d)"
            echo ""
            echo "### å¤‰æ›´å†…å®¹"
            echo ""
            echo "$commits"
            echo ""
            tail -n +7 CHANGELOG.md
          } > "$temp_file"
          mv "$temp_file" CHANGELOG.md

      - name: å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¦ã‚¿ã‚°ã‚’ä½œæˆ
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add pyproject.toml CHANGELOG.md
          git commit -m "chore: bump version to ${{ steps.version.outputs.new_version }}"
          git tag ${{ steps.version.outputs.tag_name }}

          echo "ğŸ“¤ ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒ—ãƒƒã‚·ãƒ¥ä¸­..."
          git push origin main

          echo "ğŸ·ï¸ ã‚¿ã‚°ã‚’ãƒ—ãƒƒã‚·ãƒ¥ä¸­..."
          git push origin ${{ steps.version.outputs.tag_name }}

          echo "âœ… ãƒ—ãƒƒã‚·ãƒ¥å®Œäº†"

      - name: ãƒªãƒªãƒ¼ã‚¹æº–å‚™å®Œäº†é€šçŸ¥
        run: |
          echo "ğŸ‰ ãƒªãƒªãƒ¼ã‚¹æº–å‚™ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
          echo "ğŸ“‹ ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${{ steps.version.outputs.new_version }}"
          echo "ğŸ·ï¸ ã‚¿ã‚°: ${{ steps.version.outputs.tag_name }}"
          echo "ğŸš€ ã‚¿ã‚°ãŒãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸãŸã‚ã€ãƒªãƒªãƒ¼ã‚¹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒè‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã™"
