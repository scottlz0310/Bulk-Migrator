name: Prepare Release

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Select the semantic version bump'
        required: true
        default: patch
        type: choice
        options:
          - patch
          - minor
          - major
      prerelease:
        description: 'Mark release as pre-release'
        required: false
        default: false
        type: boolean

jobs:
  prepare-release:
    name: Prepare Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    env:
      PYTHON_VERSION: '3.13'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN != '' && secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up uv
        uses: astral-sh/setup-uv@v7

      - name: Install dependencies
        run: |
          uv venv --python $PYTHON_VERSION
          uv sync

      - name: Run quality checks
        run: |
          echo "::group::Lint"
          uv run ruff check .
          echo "::endgroup::"

          echo "::group::Format"
          uv run ruff format --check .
          echo "::endgroup::"

          echo "::group::Type check"
          uv run mypy .
          echo "::endgroup::"

          echo "::group::Tests"
          uv run pytest --cov=src --cov-report=term-missing --cov-fail-under=60 --junit-xml=pytest-results.xml
          echo "::endgroup::"

      - name: Calculate next version
        id: version
        shell: bash
        run: |
          current_version=$(grep '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
          echo "Current version: $current_version"

          IFS='.' read -ra VERSION_PARTS <<< "$current_version"
          major=${VERSION_PARTS[0]}
          minor=${VERSION_PARTS[1]}
          patch=${VERSION_PARTS[2]}

          release_type="${{ github.event.inputs.release_type }}"

          case "$release_type" in
            major)
              major=$((major + 1))
              minor=0
              patch=0
              ;;
            minor)
              minor=$((minor + 1))
              patch=0
              ;;
            patch)
              patch=$((patch + 1))
              ;;
          esac

          new_version="$major.$minor.$patch"

          if [ "${{ github.event.inputs.prerelease }}" = "true" ]; then
            new_version="$new_version-rc.$(date +%Y%m%d%H%M%S)"
          fi

          echo "New version: $new_version"
          echo "new_version=$new_version" >> "$GITHUB_OUTPUT"
          echo "tag_name=v$new_version" >> "$GITHUB_OUTPUT"

      - name: Update pyproject.toml version
        run: |
          sed -i 's/^version = ".*"/version = "${{ steps.version.outputs.new_version }}"/' pyproject.toml
          echo "pyproject.toml updated to version ${{ steps.version.outputs.new_version }}"

      - name: Update CHANGELOG.md
        shell: bash
        run: |
          if [ ! -f CHANGELOG.md ]; then
            printf '%s\n' \
              '# Changelog' \
              '' \
              'All notable changes to this project will be documented in this file.' \
              '' \
              'The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),' \
              'and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).' \
              > CHANGELOG.md
          fi

          latest_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -n "$latest_tag" ]; then
            commits=$(git log "${latest_tag}..HEAD" --oneline --pretty=format:"- %s (%h)")
          else
            commits=$(git log --oneline --pretty=format:"- %s (%h)")
          fi

          temp_file=$(mktemp)
          {
            head -n 6 CHANGELOG.md
            echo
            echo "## ${{ steps.version.outputs.new_version }} - $(date +%Y-%m-%d)"
            echo
            echo "### Changes"
            echo
            echo "$commits"
            echo
            tail -n +7 CHANGELOG.md
          } > "$temp_file"
          mv "$temp_file" CHANGELOG.md

      - name: Commit and tag
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add pyproject.toml CHANGELOG.md
          git commit -m "chore: bump version to ${{ steps.version.outputs.new_version }}"
          git tag "${{ steps.version.outputs.tag_name }}"
          git push origin main
          git push origin "${{ steps.version.outputs.tag_name }}"

      - name: Summary
        run: |
          echo "Version: ${{ steps.version.outputs.new_version }}"
          echo "Tag: ${{ steps.version.outputs.tag_name }}"
