# Bulk-Migration 品質向上計画

## 現状分析

### 現在のフェーズ: Prototype → Staging移行期
- 基本機能は実装済み、運用実績あり
- テストカバレッジ・型ヒント・CI/CDの強化が必要
- セキュリティ・監視機能の本格導入が課題

---

## Phase 4: リンティング・コード品質 強化計画

### 4.1 ツール導入・設定
**優先度: 高**
- [ ] ruff設定追加（pyproject.toml）
  - ルール: E, F, W, I, UP, B, C90x, T20x
  - 行長: 88文字
- [ ] mypy設定追加
  - 段階的厳格化: 現在緩和 → staging強化
- [ ] pre-commit導入

### 4.2 既存コード修正
**優先度: 高**
- [ ] print文をlogging置換（src/全ファイル）
- [ ] 型ヒント追加（主要関数から段階的）
- [ ] Docstring追加（公開関数・クラス）
- [ ] import順序統一

### 4.3 設定ファイル作成
- [ ] pyproject.toml（ruff/mypy設定）
- [ ] .pre-commit-config.yaml
- [ ] Makefile（開発コマンド統一）

---

## Phase 5: テスト戦略・カバレッジ 強化計画

### 5.1 テスト基盤整備
**優先度: 高**
- [ ] pytest-cov導入・設定
- [ ] カバレッジ目標設定（staging: 60%）
- [ ] 既存テスト強化（test_*.py）

### 5.2 カバレッジ向上
**優先度: 中**
- [ ] 未カバー行特定・テスト追加
  - src/auth.py
  - src/transfer.py
  - src/config_manager.py
- [ ] エラーハンドリングテスト追加
- [ ] Microsoft Graph API Mock化

### 5.3 テスト品質向上
- [ ] テスト目的コメント追加
- [ ] 時刻依存処理のUTC固定
- [ ] 外部API依存のスタブ化

---

## Phase 6: CI/CD・自動化 導入計画

### 6.1 GitHub Actions設定
**優先度: 高**
- [ ] 基本ワークフロー作成
  - lint（ruff）
  - type（mypy）
  - test+coverage
- [ ] マトリクス設定（Linux/Windows/macOS × Python 3.11/3.12）
- [ ] uv導入・キャッシュ設定

### 6.2 品質ゲート設定
**優先度: 中**
- [ ] カバレッジ閾値設定
- [ ] セキュリティスキャン（CodeQL）
- [ ] 秘密情報検出

### 6.3 リリース自動化
**優先度: 低**
- [ ] Conventional Commits導入
- [ ] 自動バージョニング
- [ ] CHANGELOG自動生成

---

## Phase 7: セキュリティ・品質保証 強化計画

### 7.1 セキュリティスキャン
**優先度: 高**
- [ ] GitHub Advanced Security有効化
- [ ] bandit導入（Python セキュリティlinter）
- [ ] 依存関係脆弱性チェック

### 7.2 秘密情報管理強化
**優先度: 高**
- [ ] .env管理強化（sample.env更新）
- [ ] ログ出力のシークレットマスキング
- [ ] CI環境でのシークレット管理

### 7.3 依存関係管理
**優先度: 中**
- [ ] SBOM生成設定
- [ ] ライセンス監査設定
- [ ] 定期的依存関係更新

---

## Phase 8: 観測性・監視 強化計画

### 8.1 構造化ログ導入
**優先度: 中**
- [ ] JSON形式ログ出力
- [ ] 必須フィールド統一
  - timestamp（UTC, ISO8601）
  - level, event, message
  - logger, module
- [ ] PII情報マスキング

### 8.2 監視・メトリクス
**優先度: 低**
- [ ] 転送進捗メトリクス
- [ ] エラー率監視
- [ ] パフォーマンス監視

---

## 実装スケジュール

### Week 1-2: 基盤整備
1. ruff/mypy設定・導入
2. 既存print文のlogging置換
3. 基本テストカバレッジ測定

### Week 3-4: テスト強化
1. 未カバー行のテスト追加
2. エラーハンドリングテスト
3. カバレッジ60%達成

### Week 5-6: CI/CD導入
1. GitHub Actions基本ワークフロー
2. セキュリティスキャン設定
3. 品質ゲート設定

### Week 7-8: セキュリティ・監視
1. 構造化ログ導入
2. 秘密情報管理強化
3. 依存関係管理

---

## 成功指標

### Phase 4完了条件
- [ ] ruff check . エラー0
- [ ] mypy . エラー0（段階的厳格化）
- [ ] 全print文をlogging置換

### Phase 5完了条件
- [ ] テストカバレッジ60%以上
- [ ] 全テストにコメント・目的明記
- [ ] CI/CDでカバレッジゲート設定

### Phase 6完了条件
- [ ] GitHub Actions全チェック通過
- [ ] セキュリティスキャン0脆弱性
- [ ] 自動化されたリリースプロセス

### Phase 7-8完了条件
- [ ] 構造化ログ導入完了
- [ ] 秘密情報管理強化完了
- [ ] 監視・アラート設定完了

---

## リスク・制約事項

### 技術的制約
- Microsoft Graph API依存のテスト複雑性
- 大容量ファイル転送のテスト環境制約
- マルチプラットフォーム対応の複雑性

### 運用制約
- 本番環境での品質向上作業の影響
- 既存ユーザーへの影響最小化
- セキュリティ要件との両立

### 対応策
- 段階的導入による影響最小化
- 十分なテスト・検証期間確保
- ロールバック計画の準備

---

## 継続的改善

### 定期レビュー
- 月次: カバレッジ・品質メトリクス確認
- 四半期: セキュリティ監査・依存関係更新
- 半年: 品質ルール見直し・更新

### 品質文化醸成
- コードレビュー文化の定着
- 品質メトリクスの可視化
- 継続的学習・改善の仕組み化