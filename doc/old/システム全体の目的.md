🧭 システム全体の目的
OneDrive 上の指定ユーザー配下にある音源・ファイル群をクロール・ダウンロードし、バッチ的に SharePoint へ転送・再送する処理系。 冪等性と耐障害性を重視し、ログ主導の制御と並列処理による高速化を設計方針とする。

🗂️ モジュール構成と責務
スクリプト名 / モジュール	主な責務
auth_helper_app.py	client_credentials 認証。アクセストークンの取得とリフレッシュも担当
crawl_onedrive_files.py	OneDrive 配下の全ファイル（ID/パス/サイズ）の走査。構造付き index.json を出力
index.json	クロール結果のスナップショット（ファイル一覧＋メタ情報）
logger_preprocessor.py	upload_log.csv のバックアップ／status==SUCCESS エントリの削除
logger_writer.py	各ファイル処理ステージ（PENDING, LOCAL, DUPE, SUCCESS）の記録／更新（排他対応）
logger_reader.py	過去ログから SUCCESS ファイル一覧を取得してスキップ処理に活用
prepare_pending_files.py	index.json を元に未成功ファイルを temp_dir に DL、PENDING ログを記録（並列可）
onedrive_download.py	Graph API を用いた OneDrive → ローカルDL処理。存在チェック込み
upload_file_to_sharepoint.py	チャンクアップロード機能付き。成功時に temp ファイル削除
sharepoint_folder.py	SharePoint 側に必要なフォルダを再帰的に作成
batch_sync_app.py	temp_dir 内のファイルをログに従ってアップロード処理。DUPE / SUCCESS へ更新
retry_failed_uploads.py	status==NG なファイルをログから抽出→再取得→アップロード→ログ更新
🧩 ログ仕様
ログファイル（upload_log.csv）は以下のカラム構成を持ち、処理全体をドライブする“真実の情報源”として機能：

カラム名	内容
relative_path	OneDrive / SharePoint 上のファイル相対パス
file_name	ファイル名（例：voice123.wav）
file_size_bytes	バイト単位のサイズ
status	PENDING / LOCAL / DUPE / SUCCESS
timestamp	最終状態に更新された日時（例: 2025-06-21 09:00）
comment（任意）	エラー情報・再送回数・補足などの記録
> ✔ ログファイルの変更はすべて logger_writer.py 経由で排他制御のもと実施 > ✔ 前回の SUCCESS 行は起動時にバックアップ保存後削除（logger_preprocessor.py）

⚙️ 処理フロー（全体像）
クロール（crawl_onedrive_files.py）

OneDrive 全体から item_id, path, size を取得 → index.json 保存

処理準備（prepare_pending_files.py）

index.json を元に SUCCESS を除いた対象をスキャン

temp_dir に DLしながら logger_writer.log_event(..., status="PENDING")

アップロード本体（batch_sync_app.py）

ログ中 "PENDING" or "LOCAL" ファイルを対象にアップロード処理

成功時 DUPE → SUCCESS、tempファイル削除

失敗再送（retry_failed_uploads.py）

"NG" or "DUPE" のファイルを再DL or 再UL、ログ更新

🔐 認証と耐障害性
auth_helper_app.py にて client_credentials 認証

トークン失効時には自動リフレッシュしてリトライ

アップロード／DL処理は必ず try-catch で例外検知＋失敗ログ記録

ログによる状態管理で 中断／再開可能な冪等処理 を保証

🚀 並列処理対応
prepare_pending_files.py は DL を ThreadPoolExecutor で並列化可能

ログ書き込みは排他制御済み（_log_lock）

batch_sync_app.py も同様に並列化予定（ファイル単位タスク分離）

次はこの仕様を Markdown で整理したドキュメント形式（README.md）にしてもOKですし、 新規開発やテスト対象のモジュールがあれば、それもこのフレームに沿って進めていきましょう📘💪

ご希望あれば仕様のレイアウトやチーム向けの共有テンプレートにも最適化します！どうします？作りましょうか？