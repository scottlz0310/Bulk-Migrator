
# Bulk-Migrator 仕様書（src/配下スクリプト設計詳細）

---

## 1. プロジェクト概要
Bulk-Migratorは、OneDriveやSharePointなどのクラウドストレージ間で大量のファイルを安全かつ効率的に移行・管理するためのPython製ツール群です。設定管理、認証、ファイル転送、スキップリスト管理、ログ記録など、複数の機能モジュールで構成されています。

---

## 2. モジュール構成と役割

### 2.1 auth.py
- **目的**: クラウドサービス（例: Microsoft Graph API）への認証・トークン管理。
- **主な機能**:
  - OAuth2認証フローの実装
  - アクセストークンの取得・更新
  - 認証情報の安全な保存・読み出し

### 2.2 config_manager.py
- **目的**: 設定ファイル（config/config.json等）の読み込み・検証・管理。
- **主な機能**:
  - JSON形式の設定ファイルのパース
  - 設定値のバリデーション
  - 設定値の取得API

### 2.3 filelock.py
- **目的**: 複数プロセス/スレッドによる同時実行時の排他制御。
- **主な機能**:
  - ファイルロックの取得・解放
  - ロック状態の監視

### 2.4 logger.py
- **目的**: ログ出力の統一管理。
- **主な機能**:
  - 標準出力・ファイルへのログ出力
  - ログレベル（INFO, WARNING, ERROR等）の制御
  - ログフォーマットの統一

### 2.5 main.py
- **目的**: メインエントリーポイント。全体の制御・オーケストレーション。
- **主な機能**:
  - 設定・認証・ロガーの初期化
  - コマンドライン引数のパース
  - ファイル転送処理の起動
  - エラー処理・終了処理

### 2.6 rebuild_skip_list.py
- **目的**: スキップリスト（転送対象外ファイルリスト）の再構築。
- **主な機能**:
  - 既存スキップリストの読み込み
  - 新規スキップリストの生成・保存

### 2.7 skiplist.py
- **目的**: スキップリストの管理・参照。
- **主な機能**:
  - スキップリストの読み込み・書き込み
  - ファイルがスキップ対象かどうかの判定

### 2.8 transfer.py
- **目的**: ファイル転送処理の中核。
- **主な機能**:
  - 転送対象ファイルの列挙
  - 転送処理の実行（アップロード/ダウンロード）
  - 転送結果の記録
  - エラー・リトライ処理

---

## 3. 共通設計方針

- **設定ファイル**: JSON形式で管理。config_manager.pyで一元管理。
- **認証**: OAuth2ベース。トークンの自動更新対応。
- **排他制御**: filelock.pyでファイル単位のロックを実装。
- **ログ**: logger.pyで統一。ログレベル・出力先を柔軟に設定可能。
- **スキップリスト**: JSONまたはテキスト形式。skiplist.pyで管理。
- **エラー処理**: 例外キャッチ、リトライ、ログ記録を徹底。
- **CLI対応**: main.pyでコマンドライン引数を受け付け、柔軟な実行制御。

---

## 4. 典型的な処理フロー

1. main.pyが起動し、設定・認証・ロガーを初期化
2. スキップリスト・転送対象ファイルリストを取得
3. transfer.pyでファイル転送を実行
4. 転送結果・エラーをログに記録
5. 必要に応じてスキップリストをrebuild_skip_list.pyで再生成

---

## 5. AIによる再実装のためのポイント

- 各モジュールは単一責任原則に従い、役割を明確に分離
- 設定・認証・ロギング・排他制御・ファイル転送などは独立したクラス/関数で実装
- 例外処理・リトライ・ログ記録を徹底
- テスト容易性を考慮し、外部依存部分はインターフェース化
- CLI引数や設定ファイルで柔軟に動作を切り替え可能

---

---

## 2. 主な機能仕様

### 2.1 ファイルクロール・転送

- OneDriveの指定フォルダ配下をGraph APIで再帰的にクロールし、ファイルリストを作成
- SharePoint側の指定ドキュメントライブラリに、同一パス構造でファイルをアップロード
- ファイルサイズが4MB未満：単純PUT（1リクエストでアップロード）
- ファイルサイズが4MB以上：アップロードセッション＋チャンク分割PUT
- SharePoint側に必要なフォルダがなければAPIで自動作成

### 2.2 スキップリスト・再実行安全性

- 転送済みファイルはskip_list.jsonに記録
- バッチ再実行時はスキップリストを参照し、未転送ファイルのみ処理
- スキップ判定は「パス＋ファイル名」で行う（サイズ・タイムスタンプは無視）

### 2.3 進捗・エラーログ

- 転送開始・成功・失敗・スキップを`logs/transfer_start_success_error.log`に記録
- 1000件ごと、または一定時間ごとに進捗ログを出力
- エラー時はリトライし、最終的に失敗した場合はエラーログに記録

### 2.4 自動監視・復旧

- watchdog.pyが親プロセスとしてsrc.mainを監視
- 10分間ログ無更新時はsrc.mainをkill＆再起動
- src.mainが正常終了（終了コード0）した場合はwatchdogも自動終了

### 2.5 検証・再構築

- 転送完了後、OneDrive/SharePoint両方を再クロールし、転送漏れや不一致を検出
- スキップリスト・現状リストの再構築も可能（`--rebuild`オプション）

---

## 3. 設定・データ管理

- .env：API認証情報、転送元/先パス、ID等（必須）
- config.json：チャンクサイズ、並列数、ログパス等（任意）
- skip_list.json：転送済みファイルリスト
- `logs/transfer_start_success_error.log`：転送進捗・エラー・成功ログ
- watchdog.log：監視・再起動履歴

---

## 4. 主要クラス・関数設計

### GraphTransferClient（transfer.py）
- `upload_file_to_sharepoint(file_info, ...)`  
  → ファイルサイズに応じてPUT/チャンクアップロードを自動選択
- `_upload_small_file_to_sharepoint(...)`  
  → 小容量ファイルの単純PUT
- `_upload_large_file_to_sharepoint(...)`  
  → 大容量ファイルのアップロードセッション＋チャンクPUT
- `collect_file_targets_from_onedrive(...)`  
  → OneDrive配下のファイルリストを再帰取得

### スキップリスト管理（skiplist.py）
- `load_skip_list(path)`  
- `save_skip_list(list, path)`  
- `is_skipped(file_info, skip_list)`  
- `add_to_skip_list(file_info, path, lock_path)`

### ログ管理（logger.py）
- `log_transfer_start(file_info)`
- `log_transfer_success(file_info, elapsed)`
- `log_transfer_error(file_info, error, retry_count)`
- `log_transfer_skip(file_info)`

### 設定管理（config_manager.py）
- `get_chunk_size_mb()`
- `get_large_file_threshold_mb()`
- `get_skip_list_path()`
- `get_config(key, default, env_key=None)`

### 監視・自動再起動（src/watchdog.py）
- src.mainをサブプロセスで起動・監視
- ログ無更新時はkill＆再起動
- 正常終了時は自身も終了

---

## 5. データフロー

1. .env/`config.json`を読み込み、API認証・パラメータ取得
2. OneDriveをクロールし、転送対象ファイルリスト作成
3. スキップリストを参照し、未転送ファイルのみ転送
4. 転送進捗・エラーをログ出力
5. watchdogが監視し、フリーズ時は自動再起動
6. 転送完了後、rebuildで再クロール・検証

---

## 6. 設計思想・運用方針

- **再実行安全性**：何度でも途中から再開可能
- **堅牢性**：エラー耐性・自動復旧・詳細ログ
- **現場運用重視**：進捗監視・検証・設定一元化
- **API仕様準拠**：4MB以上はチャンクアップロード必須
- **拡張性**：設定値・ログ・スキップリスト等は全て外部ファイルで管理

---

## 7. 再実装時の注意点

- Graph APIのレートリミット・一時エラー対策・1時間での認証切れ対策
- ファイル名・パス長・属性の差異
- SharePointのドキュメントライブラリ名は一階層のみ
- OneDrive「クラウドのみ」ファイルはAPI経由推奨
- .envやconfigのパース・バリデーション
- スキップリストの更新・参照はロック制御必須
- エラーハンドリング・リトライロジックの実装
- ログ出力のフォーマット・ローテーション
- 監視・自動再起動の実装（watchdog.py）
- 再クロール・検証の実装（rebuild_skip_list.py）
